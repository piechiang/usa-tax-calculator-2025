# 税务软件实施路线图

## 当前状态总结（2025年初）

### ✅ 已完成
- 联邦2025税务引擎 (v2)
- MD/CA州税引擎
- 111个黄金案例测试全部通过
- 统一类型系统和数据流
- Hook架构重构完成
- 代码质量显著提升

### 🔄 进行中
- PDF导出功能（基础已实现）
- 客户端管理（基本框架存在）
- 数据导入/导出（部分功能）

### ❌ 待实现
- 联邦1040引擎（已禁用）
- 规则数据驱动化
- 更多州税引擎
- OCR文档识别
- 电子申报功能

---

## 阶段 1：夯实核心引擎（1-3个月）

### 1.1 完善联邦1040引擎 ⭐ 最高优先级

**目标：** 建立完整、准确的联邦税计算引擎

#### 任务清单：
- [ ] **重新启用/重构联邦1040引擎**
  - 基于当前v2引擎架构重新设计
  - 实现完整的Form 1040计算流程
  - 文件位置：`src/engine/federal/1040/`

- [ ] **实现清晰的数据流**
  ```typescript
  TaxPayerInput → Federal1040Calculator → FederalResult
  ```
  - 定义标准化的输入接口
  - 定义结构化的输出格式
  - 添加中间计算步骤追踪

- [ ] **规则数据驱动化**
  - 提取税档到 `src/engine/rules/2025/federal/taxBrackets.ts`
  - 提取抵免规则到 `src/engine/rules/2025/federal/credits.ts`
  - 提取扣除规则到 `src/engine/rules/2025/federal/deductions.ts`
  - 标准化阈值配置（EITC、CTC、教育抵免等）

- [ ] **黄金案例测试扩展**
  - 目标：增加到50+个IRS官方案例
  - 覆盖场景：
    - 单身/已婚联合/已婚分开/户主
    - 标准扣除 vs 分项扣除
    - 各种抵免组合（CTC, EITC, AOTC, LLC）
    - 资本利得（短期/长期）
    - 自雇税计算
    - NIIT和额外Medicare税
  - 文件位置：`tests/golden/federal/2025/`

**完成标准：**
- ✅ 所有50+黄金案例测试通过
- ✅ 计算结果与IRS Publication 17示例一致
- ✅ 规则数据100%外部化
- ✅ 代码覆盖率 > 90%

---

### 1.2 扩展州税框架

**目标：** 建立可扩展的州税引擎架构

#### 任务清单：
- [ ] **标准化州税引擎接口**
  - 统一State Registry模式
  - 定义标准州税输入/输出接口
  - 实现州税引擎基类

- [ ] **梳理现有MD/CA引擎**
  - 提取税档到JSON/TS配置
  - 标准化抵免计算函数
  - 建立规则DSL（Domain Specific Language）

- [ ] **扩展州税覆盖**
  优先级顺序（基于使用频率）：
  1. ✅ MD (Maryland) - 已完成
  2. ✅ CA (California) - 已完成
  3. 🔄 FL (Florida) - 无州所得税（简单）
  4. 🔄 NY (New York) - 复杂州
  5. 🔄 NJ (New Jersey) - 复杂州
  6. 🔄 PA (Pennsylvania) - 单一税率
  7. 🔄 TX (Texas) - 无州所得税
  8. ... 其他州按需添加

- [ ] **州税黄金案例**
  - 每个州至少20个测试案例
  - 覆盖本州特殊抵免
  - 文件位置：`tests/golden/states/{state}/2025/`

**完成标准：**
- ✅ 至少5个州引擎完成
- ✅ 州税框架文档完整
- ✅ 每个州黄金案例100%通过

---

### 1.3 输出格式基础

**目标：** 实现专业的税表输出和电子申报准备

#### 任务清单：
- [ ] **完善PDF输出**
  - 基于现有`PDFRenderer`模块扩展
  - 支持Form 1040主表
  - 支持常见附表：
    - Schedule 1 (额外收入和调整)
    - Schedule 2 (额外税款)
    - Schedule 3 (额外抵免和付款)
    - Schedule A (分项扣除)
    - Schedule B (利息和股息)
    - Schedule C (自雇收入)
    - Schedule D (资本利得)
    - Schedule E (租金和版税)
    - Schedule SE (自雇税)
  - 添加水印、签名区域

- [ ] **电子申报准备**
  - 研究IRS XML Schema (1040 MeF)
  - 实现基础XML转换器
  - 概念验证：将1040数据转换为IRS XML格式
  - 文件位置：`src/utils/efile/`

**完成标准：**
- ✅ 可生成完整的1040 PDF包
- ✅ XML格式符合IRS MeF标准
- ✅ 支持至少5个常用附表

---

## 阶段 2：准备人工作流 & 数据采集（3-6个月）

### 2.1 客户端管理增强

**目标：** 建立专业的客户关系管理系统

#### 任务清单：
- [ ] **扩展ClientManager功能**
  - 客户信息管理（联系方式、地址、状态）
  - 文档管理（上传、分类、历史）
  - K-1数据导入和映射
  - 多税年支持（2024、2025等）
  - 快照版本控制

- [ ] **协作功能**
  - 任务分配和跟踪
  - 评论和批注系统
  - 审计日志（谁改了什么、何时改的）
  - 状态工作流（新建→进行中→审查→完成）

**文件位置：**
- `src/components/pro/ClientManager.tsx`
- `src/components/collaboration/CollaborativeTaxPrep.tsx`

---

### 2.2 文档采集新体验

**目标：** 自动化文档处理和数据提取

#### 任务清单：
- [ ] **OCR增强**
  - 集成OCR引擎（Tesseract.js / AWS Textract）
  - W-2自动识别（雇主信息、工资、预扣税）
  - 1099表单识别（利息、股息、资本利得）
  - 1098表单识别（抵押贷款利息）
  - 自动字段映射到表单

- [ ] **批量上传和分类**
  - 拖放文件上传
  - 自动文档分类（基于文件名/内容）
  - 进度跟踪
  - 错误处理和重试

- [ ] **问答式采集**
  - 扩展InterviewFlow组件
  - 智能问题分支（基于之前答案）
  - 进度保存和恢复
  - 直接写入TaxContext

**文件位置：**
- `src/components/ocr/DocumentScanner.tsx`
- `src/components/interview/InterviewFlow.tsx`

---

### 2.3 导入/导出

**目标：** 与外部系统无缝集成

#### 任务清单：
- [ ] **会计软件集成**
  - QuickBooks CSV导入
  - Xero API集成（如可行）
  - Trial Balance → Schedule C映射

- [ ] **上年数据导入**
  - 支持JSON格式（自己的格式）
  - 支持常见税务软件格式
  - 年比年比较功能

- [ ] **标准化导出**
  - JSON导出（完整数据）
  - CSV导出（摘要数据）
  - PDF包导出

**文件位置：**
- `src/components/import/DataImportExport.tsx`
- `src/utils/importers.ts`

---

## 阶段 3：质量保障 & 安全（6-9个月）

### 3.1 自动化测试体系

#### 任务清单：
- [ ] **单元测试扩展**
  - 目标：每个新Hook都有测试
  - 引擎函数100%覆盖
  - 使用Vitest + React Testing Library

- [ ] **E2E测试**
  - 使用Playwright
  - 关键流程：
    - 完整的税务申报流程
    - PDF生成
    - 数据导入导出
    - 客户管理流程

- [ ] **Golden Snapshots**
  - 版本化测试数据
  - 自动比较输出差异
  - CI/CD集成

---

### 3.2 日志与监控

#### 任务清单：
- [ ] **结构化日志**
  - 关键函数添加telemetry
  - 输入/输出记录
  - 性能指标收集

- [ ] **错误跟踪**
  - 集成Sentry或自建
  - 错误分类和优先级
  - 自动报警

- [ ] **版本化快照**
  - 支持快照回滚
  - 操作日志生成（审计需求）

---

### 3.3 安全与权限

#### 任务清单：
- [ ] **数据加密**
  - 静态数据加密（AES-256）
  - 传输加密（TLS 1.3）
  - 敏感字段额外保护（SSN、银行账号）

- [ ] **用户体系**
  - 角色定义：准备人/审查人/管理员/客户
  - 权限控制（RBAC）
  - 登录MFA（集成Auth0/Keycloak）

- [ ] **合规性**
  - IRS安全要求
  - 数据留存政策
  - 审计日志

---

## 阶段 4：智能化和专业化（9-12个月）

### 4.1 诊断 & 建议引擎

#### 任务清单：
- [ ] **扩展诊断规则**
  - 缺少必填表格检测
  - 未申请抵免提醒
  - 异常值警告（AGI显著变化、大额扣除等）

- [ ] **节税建议库**
  - Retirement账户优化
  - HSA建议
  - 教育储蓄建议
  - 州抵免机会

**文件位置：**
- `src/components/audit/TaxReviewAccuracy.tsx`

---

### 4.2 预测 & 规划

#### 任务清单：
- [ ] **年中规划**
  - YTD实际数据 + 剩余年份估算
  - 预缴税款计算
  - 调整建议

- [ ] **场景分析**
  - Roth转换分析
  - 慈善捐赠时机
  - 资本利得收割

---

### 4.3 AI助手（可选）

**注意：** 只在完成结构化数据后考虑

#### 潜在应用：
- 文档智能解析（OCR + LLM）
- 客户沟通邮件生成
- 税务问答机器人
- 复杂情况解释

---

## 阶段 5：产品化与生态（12-18个月）

### 5.1 报税包交付

#### 任务清单：
- [ ] **自动化交付**
  - Summary letter生成
  - Diagnostics报告
  - Schedule汇总
  - Payment voucher

- [ ] **电子签名**
  - 集成DocuSign
  - 或Adobe Sign
  - 8879表单支持

---

### 5.2 多实体联动

#### 任务清单：
- [ ] **实体图谱**
  - S-Corp → K-1 → 1040流程
  - Partnership → K-1 → 1040流程
  - Trust实体支持

- [ ] **企业税模块**
  - Form 1120 (C-Corp)
  - Form 1065 (Partnership)
  - Form 990 (Non-profit)

---

### 5.3 商业化准备

#### 任务清单：
- [ ] **订阅体系**
  - 许可证管理
  - 使用计量
  - Billing API

- [ ] **多租户**
  - 数据隔离
  - 性能优化
  - 后台管理系统

---

## 📅 短期执行计划（下一步行动）

### 第1周：
1. ✅ 完成代码重构（已完成）
2. 🔄 梳理现有测试用例
3. 🔄 规划联邦1040引擎重构

### 第2-4周：
1. 重新实现联邦1040引擎
2. 提取规则数据到配置文件
3. 添加20个新的黄金案例

### 第5-8周：
1. 标准化州税框架
2. 添加NY/NJ州引擎
3. 完善PDF输出功能

### 第9-12周：
1. 实现基础电子申报XML
2. 增强客户管理功能
3. 添加OCR基础功能

---

## 🎯 成功指标

### 技术指标：
- [ ] 代码覆盖率 > 90%
- [ ] 所有黄金案例测试通过
- [ ] 零TypeScript错误
- [ ] 零ESLint警告

### 业务指标：
- [ ] 支持至少5个州
- [ ] 支持至少10个常用附表
- [ ] 可生成完整PDF报税包
- [ ] 计算准确率 = 100%（对比IRS示例）

### 性能指标：
- [ ] 页面加载 < 2秒
- [ ] 税务计算 < 500ms
- [ ] PDF生成 < 5秒

---

## 💡 建议

1. **每完成一个里程碑都要对照Lacerte做GAP分析**
2. **优先处理影响计算准确性的功能**
3. **建立持续集成/持续部署(CI/CD)**
4. **定期代码审查和重构**
5. **文档化每个模块的设计决策**

---

## 📚 参考资源

- IRS Publication 17 (联邦个人所得税)
- IRS e-File MeF Schema
- 各州税务局网站
- Lacerte功能清单
- Professional tax preparer workflows

---

最后更新：2025年初
版本：1.0
